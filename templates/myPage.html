{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„</title>

    <link rel="stylesheet" href="{% static 'css/myPage.css' %}">
    <link rel="stylesheet" href="{% static 'css/login_button.css' %}">
    <script src="{% static 'js/myPage.js' %}"></script>


    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <script src=https://cdn.tailwindcss.com></script>

</head>

<body style="background-image: url('{{ profile.page_background.url }}'); background-size: cover;">
    <!-- å¯¼èˆªæ  -->
    <header class="py-6 px-4 md:px-8 flex justify-between items-center bg-white bg-opacity-70">
        <div class="absolute left-1/2 transform -translate-x-1/2">
            <a class="text-3xl md:text-4xl font-bold fade-in">SignLinkæ‰‹è¯­é€š</a>
            <p class="text-lg md:text-xl opacity-80 fade-in mt-2">è¿æ¥æ‰‹è¯­ä¸–ç•Œï¼Œæ²Ÿé€šæ— éšœç¢</p>
        </div>

        <div class="flex items-center space-x-4 ml-auto">
            {% if user.is_authenticated %}
            <div class="user-menu-box-container">
                <a href="{% url 'my_page' %}" class="user-menu-box-button">
                    {% if user.avatar %}
                    <img src="{{ user.avatar.url }}" alt="å¤´åƒ" class="user-menu-box-avatar">
                    {% else %}
                    <img src="{% static 'images/default_avatar.png' %}" alt="é»˜è®¤å¤´åƒ" class="user-menu-box-avatar">
                    {% endif %}
                    {{ user.username }}
                </a>
                <div class="user-menu-box-dropdown">
                    <a href="{% url 'my_page' %}">è¿›å…¥ä¸ªäººä¸»é¡µ</a>
                    <a href="{% url 'logout' %}">é€€å‡ºç™»å½•</a>
                </div>
            </div>
            {% else %}
            <a href="{% url 'login' %}" class="user-menu-box-login">
                <i class="fas fa-user"></i> ç™»å½•
            </a>
            {% endif %}
        </div>
    </header>
    <nav class="sticky top-0 bg-white bg-opacity-90 backdrop-blur-sm py-4 px-4 md:px-8 z-50 fade-in"
        style="border-bottom: 1px solid var(--border-color);">
        <div class="container mx-auto flex justify-center space-x-8">
            <a class="nav-link text-lg font-medium" href="{% url 'home' %}" style="color:var(--text-color)">é¦–é¡µ</a>
            <a class="nav-link text-lg font-medium" href="{% url 'sl_classroom' %}"
                style="color:var(--text-color)">æ‰‹è¯­æ•™å®¤</a>
            <a class="nav-link text-lg font-medium" href="{% url 'life_serving' %}"
                style="color:var(--text-color)">ç”Ÿæ´»æœåŠ¡</a>
            <a class="nav-link text-lg font-medium" href="{% url 'community' %}"
                style="color:var(--text-color)">æ‰‹è¯­ç¤¾åŒº</a>
            <a class="nav-link text-lg font-medium" href="{% url 'schedule' %}" style="color:var(--text-color)">æ—¥ç¨‹ç®¡ç†</a>
            <a class="nav-link text-lg font-medium" href="{% url 'my_page' %}" style="color:var(--text-color)">æˆ‘çš„</a>
        </div>
    </nav>

    <form method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        <!-- é¡µé¢èƒŒæ™¯ä¸Šä¼ æ§ä»¶ -->
        <div class="bg-upload-container">
            <label for="bgInput" class="bg-upload-label">æ›´æ¢èƒŒæ™¯</label>
            <input type="file" name="page_background" id="bgInput" class="bg-upload" accept="image/*"
                onchange="changePageBg(event)">
        </div>

        <div class="profile-page">
            <!-- ä¸ªäººä¿¡æ¯åŒºåŸŸ -->
            <div class="profile-page">
                <div class="profile-header">
                    <div class="profile-container">
                        <!-- ä¸ªäººèµ„æ–™èƒŒæ™¯ -->
                        <div class="profile-banner" id="profileBanner"
                            style="background-image: url('{{ profile.personal_background.url }}');">
                            <input type="file" name="personal_background" accept="image/*" hidden id="uploadBanner"
                                onchange="changeBanner(event)">
                            <button type="button" class="change-banner-btn"
                                onclick="document.getElementById('uploadBanner').click()">æ›´æ¢ä¸ªäººèµ„æ–™èƒŒæ™¯</button>
                        </div>

                        <!-- å¤´åƒ -->
                        <div class="profile-avatar-container">
                            <input type="file" name="avatar" accept="image/*" hidden id="uploadAvatar"
                                onchange="changeAvatar(event)">
                            <img src="{% if user.avatar %}{{ user.avatar.url }}{% else %}{% static 'images/default_avatar.png' %}{% endif %}"
                                class="profile-avatar" id="profileAvatar"
                                onclick="document.getElementById('uploadAvatar').click()">
                        </div>

                        <!-- ç”¨æˆ·èµ„æ–™ -->
                        <div class="profile-content">
                            <h2 class="profile-name">{{ user.username }}</h2>
                            <p class="profile-bio">{{ profile.bio }}</p>

                            <!-- ç¼–è¾‘å¼¹çª— -->
                            <div class="modal-overlay" id="modalOverlay"></div>
                            <div class="profile-modal" id="profileModal">
                                <span class="close-modal" onclick="closeProfileEdit()">&times;</span>
                                <h3 style="text-align:center;">ç¼–è¾‘ä¸ªäººèµ„æ–™</h3>

                                <label>ç”¨æˆ·åï¼š</label>
                                <input type="text" name="username" value="{{ user.username }}">

                                <label>ä¸ªæ€§ç­¾åï¼š</label>
                                <textarea name="bio">{{ profile.bio }}</textarea>

                                <button type="submit" class="update-profile-btn">æ›´æ–°èµ„æ–™</button>
                            </div>

                            <div class="profile-update-notice" id="profileUpdateNotice">ä¸ªäººèµ„æ–™å·²æ›´æ–°ï¼</div>
                            <button class="edit-profile-btn" type="button" onclick="openProfileEdit()">ç¼–è¾‘èµ„æ–™</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>


    <!-- åˆ†æ å¸ƒå±€ -->
    <div class="main-content">
        <!-- å·¦æ ï¼šå…³æ³¨åˆ—è¡¨ -->
        <div class="left-column">
            <h3>æˆ‘å…³æ³¨çš„äºº</h3>
            <hr class="divider">
            <div class="friend-list-container">
                {% for follow in follows %}
                <div class="friend-item">
                    <img class="w-10 h-10 rounded-full object-cover"
                        src="{{ follow.followed.avatar.url|default:'/static/images/default_avatar.png' }}" alt="å¤´åƒ"
                        class="user-avatar" />
                    <span>{{ follow.followed.username }}</span>
                </div>
                {% empty %}
                <p class="text-gray-400">ä½ è¿˜æ²¡æœ‰å…³æ³¨ä»»ä½•äºº</p>
                {% endfor %}
            </div>
        </div>

        <!-- ä¸­æ ï¼šå¸–å­å†…å®¹ -->
        <div class="middle-column">
            <div class="tab">
                <button class="tablinks" onclick="openTab(event, 'myPosts')" id="defaultOpen">
                    <i class="fas fa-home"></i> æˆ‘çš„å¸–å­
                </button>
                <button class="tablinks" onclick="openTab(event, 'myFavorites')">
                    <i class="fas fa-heart"></i> æˆ‘çš„æ”¶è—
                </button>
                <button class="tablinks" onclick="openTab(event, 'myLikes')">
                    <i class="fas fa-thumbs-up"></i> æˆ‘çš„èµ
                </button>
            </div>

            <!-- æˆ‘çš„å¸–å­ -->
            <div id="myPosts" class="tabcontent">
                {% for post in my_posts %}
                <div class="relative post-card shadow-md rounded-lg p-4 mb-6 bg-white dark:bg-gray-800">
                    <!-- ç”¨æˆ·ä¿¡æ¯åŒº -->
                    <div class="post-header flex items-center space-x-3 mb-2">
                        {% if post.user.avatar %}
                        <img class="w-10 h-10 rounded-full object-cover" src="{{ post.user.avatar.url }}" alt="ç”¨æˆ·å¤´åƒ">
                        {% else %}
                        <img class="w-10 h-10 rounded-full object-cover" src="{% static 'images/default_avatar.png' %}"
                            alt="é»˜è®¤å¤´åƒ">
                        {% endif %}
                        <div>
                            <h3 class="font-semibold text-gray-900 dark:text-gray-100">{{ post.user.username }}</h3>
                            <p class="text-sm text-gray-500">{{ post.created_at|timesince }}å‰</p>
                        </div>

                        <div class="absolute top-4 right-4 z-10">
                            <button onclick="toggleOptionsMenuDelete(this)"
                                class="text-gray-500 hover:text-gray-800 dark:hover:text-white">
                                <i class="fas fa-ellipsis-h"></i>
                            </button>
                            <div
                                class="options-menu hidden absolute right-0 mt-2 w-32 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-lg">
                                <form method="post" action="{% url 'delete_post' post.id %}"
                                    onsubmit="return confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å¸–å­å—ï¼Ÿ');">
                                    {% csrf_token %}
                                    <button type="submit"
                                        class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100 dark:hover:bg-gray-600">
                                        åˆ é™¤å¸–å­
                                    </button>
                                </form>
                            </div>
                        </div>

                    </div>

                    <!-- å¸–å­å†…å®¹ -->
                    <div class="post-content text-gray-800 dark:text-gray-200 mb-2">
                        <p>{{ post.content }}</p>
                    </div>

                    <!-- åª’ä½“å±•ç¤º -->
                    <div class="post-media space-y-2">
                        {% if post.image %}
                        <img src="{{ post.image.url }}" alt="å¸–å­å›¾ç‰‡" class="w-full rounded-lg">
                        {% endif %}
                        {% if post.video %}
                        <video controls class="w-1/2 h-auto rounded-lg">
                            <source src="{{ post.video.url }}" type="video/mp4">
                        </video>
                        {% endif %}
                    </div>

                    <!-- ç®€æ´ä¿¡æ¯å±•ç¤ºåŒº -->
                    <div class="post-actions flex space-x-4 text-sm text-gray-600 mt-4">
                        <div><i class="fa-regular fa-heart mr-1"></i>{{ post.like_count }}</div>
                        <div><i class="fa-regular fa-comment-dots mr-1"></i>{{ post.comment_count }}</div>
                        <div><i class="fa-regular fa-bookmark mr-1"></i>{{ post.favorite_count }}</div>
                    </div>

                    <!-- è¯„è®ºå±•ç¤ºï¼ˆæœ€å¤šå±•ç¤ºå‰å‡ æ¡ï¼‰ -->
                    {% if post.comment_set.all %}
                    <div class="post-comments mt-4 space-y-2 text-sm text-gray-700 dark:text-gray-300">
                        {% for comment in post.comment_set.all|slice:":3" %}
                        <div><strong>{{ comment.user.username }}</strong>: {{ comment.content }}</div>
                        {% endfor %}
                        {% if post.comment_set.count > 3 %}
                        <div class="text-gray-400 italic">â€¦â€¦æ›´å¤šè¯„è®º</div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
                {% empty %}
                <p class="text-gray-500 text-center mt-6">æš‚æ— å†…å®¹ã€‚</p>
                {% endfor %}

            </div>

            <!-- æˆ‘çš„æ”¶è— -->
            <div id="myFavorites" class="tabcontent" style="display: none;">
                {% for post in favorited_posts %}
                <div class="post-card shadow-md rounded-lg p-4 mb-6 bg-white dark:bg-gray-800">
                    <!-- ç”¨æˆ·ä¿¡æ¯åŒº -->
                    <div class="post-header flex items-center space-x-3 mb-2">
                        {% if post.user.avatar %}
                        <img class="w-10 h-10 rounded-full object-cover" src="{{ post.user.avatar.url }}" alt="ç”¨æˆ·å¤´åƒ">
                        {% else %}
                        <img class="w-10 h-10 rounded-full object-cover" src="{% static 'images/default_avatar.png' %}"
                            alt="é»˜è®¤å¤´åƒ">
                        {% endif %}
                        <div>
                            <h3 class="font-semibold text-gray-900 dark:text-gray-100">{{ post.user.username }}</h3>
                            <p class="text-sm text-gray-500">{{ post.created_at|timesince }}å‰</p>
                        </div>
                    </div>

                    <!-- å¸–å­å†…å®¹ -->
                    <div class="post-content text-gray-800 dark:text-gray-200 mb-2">
                        <p>{{ post.content }}</p>
                    </div>

                    <!-- åª’ä½“å±•ç¤º -->
                    <div class="post-media space-y-2">
                        {% if post.image %}
                        <img src="{{ post.image.url }}" alt="å¸–å­å›¾ç‰‡" class="w-full rounded-lg">
                        {% endif %}
                        {% if post.video %}
                        <video controls class="w-1/2 h-auto rounded-lg">
                            <source src="{{ post.video.url }}" type="video/mp4">
                        </video>
                        {% endif %}
                    </div>

                    <!-- ç®€æ´ä¿¡æ¯å±•ç¤ºåŒº -->
                    <div class="post-actions flex space-x-4 text-sm text-gray-600 mt-4">
                        <div><i class="fa-regular fa-heart mr-1"></i>{{ post.like_count }}</div>
                        <div><i class="fa-regular fa-comment-dots mr-1"></i>{{ post.comment_count }}</div>
                        <div><i class="fa-regular fa-bookmark mr-1"></i>{{ post.favorite_count }}</div>
                    </div>

                    <!-- è¯„è®ºå±•ç¤ºï¼ˆæœ€å¤šå±•ç¤ºå‰å‡ æ¡ï¼‰ -->
                    {% if post.comment_set.all %}
                    <div class="post-comments mt-4 space-y-2 text-sm text-gray-700 dark:text-gray-300">
                        {% for comment in post.comment_set.all|slice:":3" %}
                        <div><strong>{{ comment.user.username }}</strong>: {{ comment.content }}</div>
                        {% endfor %}
                        {% if post.comment_set.count > 3 %}
                        <div class="text-gray-400 italic">â€¦â€¦æ›´å¤šè¯„è®º</div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
                {% empty %}
                <p class="text-gray-500 text-center mt-6">æš‚æ— å†…å®¹ã€‚</p>
                {% endfor %}
            </div>

            <!-- æˆ‘çš„ç‚¹èµ -->
            <div id="myLikes" class="tabcontent" style="display: none;">
                {% for post in liked_posts %}
                <div class="post-card shadow-md rounded-lg p-4 mb-6 bg-white dark:bg-gray-800">
                    <!-- ç”¨æˆ·ä¿¡æ¯åŒº -->
                    <div class="post-header flex items-center space-x-3 mb-2">
                        {% if post.user.avatar %}
                        <img class="w-10 h-10 rounded-full object-cover" src="{{ post.user.avatar.url }}" alt="ç”¨æˆ·å¤´åƒ">
                        {% else %}
                        <img class="w-10 h-10 rounded-full object-cover" src="{% static 'images/default_avatar.png' %}"
                            alt="é»˜è®¤å¤´åƒ">
                        {% endif %}
                        <div>
                            <h3 class="font-semibold text-gray-900 dark:text-gray-100">{{ post.user.username }}</h3>
                            <p class="text-sm text-gray-500">{{ post.created_at|timesince }}å‰</p>
                        </div>
                    </div>

                    <!-- å¸–å­å†…å®¹ -->
                    <div class="post-content text-gray-800 dark:text-gray-200 mb-2">
                        <p>{{ post.content }}</p>
                    </div>

                    <!-- åª’ä½“å±•ç¤º -->
                    <div class="post-media space-y-2">
                        {% if post.image %}
                        <img src="{{ post.image.url }}" alt="å¸–å­å›¾ç‰‡" class="w-full rounded-lg">
                        {% endif %}
                        {% if post.video %}
                        <video controls class="w-1/2 h-auto rounded-lg">
                            <source src="{{ post.video.url }}" type="video/mp4">
                        </video>
                        {% endif %}
                    </div>

                    <!-- ç®€æ´ä¿¡æ¯å±•ç¤ºåŒº -->
                    <div class="post-actions flex space-x-4 text-sm text-gray-600 mt-4">
                        <div><i class="fa-regular fa-heart mr-1"></i>{{ post.like_count }}</div>
                        <div><i class="fa-regular fa-comment-dots mr-1"></i>{{ post.comment_count }}</div>
                        <div><i class="fa-regular fa-bookmark mr-1"></i>{{ post.favorite_count }}</div>
                    </div>

                    <!-- è¯„è®ºå±•ç¤ºï¼ˆæœ€å¤šå±•ç¤ºå‰å‡ æ¡ï¼‰ -->
                    {% if post.comment_set.all %}
                    <div class="post-comments mt-4 space-y-2 text-sm text-gray-700 dark:text-gray-300">
                        {% for comment in post.comment_set.all|slice:":3" %}
                        <div><strong>{{ comment.user.username }}</strong>: {{ comment.content }}</div>
                        {% endfor %}
                        {% if post.comment_set.count > 3 %}
                        <div class="text-gray-400 italic">â€¦â€¦æ›´å¤šè¯„è®º</div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
                {% empty %}
                <p class="text-gray-500 text-center mt-6">æš‚æ— å†…å®¹ã€‚</p>
                {% endfor %}
            </div>
        </div>


        <!-- å³æ ï¼šäº’åŠ¨é€šçŸ¥åŒº -->
        <div class="right-column">
            <!-- ğŸ“… å³å°†åˆ°æ¥çš„æ—¥ç¨‹ -->
            <div class="notification-card mt-4">
                <h4>ğŸ“… å³å°†åˆ°æ¥çš„æ—¥ç¨‹</h4>
                <ul>
                    {% for event in upcoming_events %}
                    <li class="text-sm mb-2">
                        <i class="fas fa-calendar-alt text-purple-500 mr-1"></i>
                        <strong>{{ event.title }}</strong><br>
                        <span class="text-gray-500 text-xs">{{ event.datetime|date:"Yå¹´mæœˆdæ—¥ H:i" }}</span>
                    </li>
                    {% endfor %}
                    {% if not upcoming_events %}
                    <li class="text-gray-500">æš‚æ— å³å°†åˆ°æ¥çš„æ—¥ç¨‹</li>
                    {% endif %}
                </ul>
                <div class="text-right mt-2">
                    <a href="{% url 'schedule' %}" class="text-sm text-primary hover:underline">æŸ¥çœ‹å…¨éƒ¨æ—¥ç¨‹ &rarr;</a>
                </div>
            </div>

            <!-- âœ… æˆ‘çš„å¾…åŠäº‹é¡¹ -->
            <div class="notification-card mt-4">
                <h4>âœ… æˆ‘çš„å¾…åŠäº‹é¡¹</h4>
                <ul>
                    {% for task in recent_tasks %}
                    <li class="text-sm mb-2">
                        <i class="fas fa-check-circle text-green-500 mr-1"></i>
                        {{ task.text }}
                        <span class="text-gray-400 text-xs block">æ·»åŠ äº {{ task.created_at|date:"mæœˆdæ—¥ H:i" }}</span>
                    </li>
                    {% endfor %}
                    {% if not recent_tasks %}
                    <li class="text-gray-500">æš‚æ— æœªå®Œæˆçš„ä»»åŠ¡</li>
                    {% endif %}
                </ul>
                <div class="text-right mt-2">
                    <a href="{% url 'schedule' %}" class="text-sm text-primary hover:underline">å‰å¾€æ—¥ç¨‹ç®¡ç† &rarr;</a>
                </div>
            </div>

            <div class="notification-card notifications">
                <h4>ğŸ”” äº’åŠ¨é€šçŸ¥</h4>
                <ul>
                    {% for like in recent_likes %}
                    <li>
                        <i class="fas fa-heart text-red-500"></i>
                        <strong>{{ like.user.username }}</strong> ç‚¹èµäº†ä½ çš„å¸–å­ï¼š
                        <span>{{ like.post.content|truncatechars:12 }}</span>
                    </li>
                    {% endfor %}

                    {% for comment in recent_comments %}
                    <li>
                        <i class="fas fa-comment-dots text-blue-500"></i>
                        <strong>{{ comment.user.username }}</strong> è¯„è®ºäº†ä½ çš„å¸–å­ï¼š
                        <span>{{ comment.content|truncatechars:12 }}</span>
                    </li>
                    {% endfor %}

                    {% if not recent_likes and not recent_comments %}
                    <li class="text-gray-500">æš‚æ— äº’åŠ¨</li>
                    {% endif %}
                </ul>
            </div>
        </div>



    </div>

    <footer class="py-8 px-4 md:px-8 text-center fade-in" style=animation-delay:1.2s>
        <div class="flex flex-col items-center">
            <div class="mb-4 text-lg font-medium">ä½œè€…: èµµä¸€èŠ¬ å¾åª›é“ƒ ææ€å¦</div>
            <p class="text-sm opacity-70">Â© 2025 SignLinkæ‰‹è¯­é€š. ä¿ç•™æ‰€æœ‰æƒåˆ©.
        </div>
    </footer>

</body>

</html>