{% load static %}
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SignLink手语通 - 日程管理</title>
    <link rel="stylesheet" href="{% static 'css/login_button.css' %}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // 配置Tailwind自定义颜色
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#8d6a95',
                        secondary: '#cebbf3',
                        dark: '#1a1a1a',
                        light: '#f9f9f9',
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        :root {
            --primary: #8d6a95;
            --primary-light: #cebbf3;
            --bg-color: #f9f9f9;
            --card-bg: #fff;
            --text-color: hsl(301, 89%, 21%);
            --border-color: #e5e5e5;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Noto Sans SC', sans-serif;
            transition: background-color .3s, color .3s;
            padding: 2rem 5%;
            max-width: 1440px;
            margin: 0 auto;
            box-sizing: border-box;
        }

        
        @media (min-width: 1600px) {
            body {
                padding: 2rem 8%;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 1.5rem;
            }
        }

        .main-container {
            padding: 0 2rem;
            margin: 0 auto;
        }

        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            transition: transform .3s, box-shadow .3s, border-color .3s;
            margin: 1rem 0;
            padding: 1.5rem;
        }

        .card:hover {
            border-color: var(--primary);
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .btn {
            transition: transform .2s, background-color .2s;
        }

        .btn:hover {
            transform: scale(1.05);
        }

        .fade-in {
            animation: .8s ease-in fadeIn;
        }

        @keyframes fadeIn {
            0% {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .nav-link {
            position: relative;
        }

        .nav-link:after {
            content: "";
            background-color: var(--primary);
            width: 0;
            height: 2px;
            transition: width .3s;
            position: absolute;
            bottom: -2px;
            left: 0;
        }

        .nav-link:hover:after,
        .nav-link.active:after {
            width: 100%;
        }

        /* 日历专用样式 */
        .calendar-day {
            min-height: 100px;
            border: 1px solid var(--border-color);
            border-radius: 0.25rem;
            padding: 0.5rem;
            transition: all 0.2s ease;
        }
        
        .calendar-day:hover {
            background-color: rgba(206, 187, 243, 0.1);
        }
        
        .day-header {
            background-color: var(--card-bg);
            font-weight: bold;
            text-align: center;
            padding: 0.5rem;
            border-radius: 0.25rem;
        }
        
        .day-number {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary);
        }
        
        .event-marker {
            position: absolute;
            bottom: 0.5rem;
            left: 0.5rem;
            right: 0.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
        }
        
        .event-dot {
            width: 0.5rem;
            height: 0.5rem;
            border-radius: 9999px;
            background-color: var(--primary);
        }
    </style>
</head>
<body >
    <header class="py-6 px-4 md:px-8 flex justify-between items-center">
        <div class="absolute left-1/2 transform -translate-x-1/2">
            <a class="text-3xl md:text-4xl font-bold fade-in">SignLink手语通</a>
            <p class="text-lg md:text-xl opacity-80 fade-in mt-2">连接手语世界，沟通无障碍</p>
        </div>

        <div class="flex items-center space-x-4 ml-auto">
            <div class="flex items-center space-x-4 ml-auto">
                {% if user.is_authenticated %}
                <div class="user-menu-box-container">
                    <a href="{% url 'my_page' %}" class="user-menu-box-button">
                        {% if user.avatar %}
                        <img src="{{ user.avatar.url }}" alt="头像" class="user-menu-box-avatar">
                        {% else %}
                        <img src="{% static 'images/default_avatar.png' %}" alt="默认头像" class="user-menu-box-avatar">
                        {% endif %}
                        {{ user.username }}
                    </a>
                    <div class="user-menu-box-dropdown">
                        <a href="{% url 'my_page' %}">进入个人主页</a>
                        <a href="{% url 'logout' %}">退出登录</a>
                    </div>
                                    </div>
                {% else %}
                <a href="{% url 'login' %}" class="user-menu-box-login">
                    <i class="fas fa-user"></i> 登录
                </a>
                {% endif %}
            </div>
    </header>
        <nav class="sticky top-0 bg-opacity-90 backdrop-blur-sm py-4 px-4 md:px-8 z-50 fade-in" style="background-color:var(--card-bg)">
            <div class="container mx-auto flex justify-center space-x-8">
                <a class="nav-link text-lg font-medium" href="{% url 'home' %}" style="color:var(--text-color)">首页</a>
                <a class="nav-link text-lg font-medium" href="{% url 'sl_classroom' %}" style="color:var(--text-color)">手语教室</a>
                <a class="nav-link text-lg font-medium" href="{% url 'life_serving' %}" style="color:var(--text-color)">生活服务</a>
                <a class="nav-link text-lg font-medium" href="{% url 'community' %}" style="color:var(--text-color)">手语社区</a>
                <a class="nav-link text-lg font-medium" href="{% url 'schedule' %}" style="color:var(--text-color)">日程管理</a>
                <a class="nav-link text-lg font-medium" href="{% url 'my_page' %}" style="color:var(--text-color)">我的</a>
            </div>
        </nav>

    <!-- 主内容区 -->
    <main class="container mx-auto px-4 py-8">
        <div class="mb-8 fade-in">
            <h2 class="text-[clamp(1.5rem,3vw,2.5rem)] font-bold text-primary flex items-center">
                <i class="fa fa-calendar-check-o mr-3"></i>日程管理
            </h2>
        </div>

        <!-- 日历容器 -->
        <div class="card rounded-xl hover:shadow-lg mb-8">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-primary flex items-center">
                    <i class="fa fa-calendar mr-2"></i>我的日历
                </h3>
                <div class="flex space-x-2">
                    <button onclick="prevMonth()" class="p-2 rounded-full hover:bg-primary-light/50 transition-colors">
                        <i class="fa fa-chevron-left text-primary"></i>
                    </button>
                    <button onclick="goToToday()" class="px-4 py-2 bg-primary text-white rounded-full hover:bg-primary-light transition-colors">
                        今天
                    </button>
                    <button onclick="nextMonth()" class="p-2 rounded-full hover:bg-primary-light/50 transition-colors">
                        <i class="fa fa-chevron-right text-primary"></i>
                    </button>
                </div>
            </div>

            <div class="mb-4">
                <h4 id="currentMonthDisplay" class="text-2xl font-bold text-center text-primary"></h4>
            </div>

            <div id="calendar" class="mb-8"></div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <!-- 待办事项区域 -->
            <div class="lg:col-span-5 card rounded-xl hover:shadow-lg">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-primary flex items-center">
                        <i class="fa fa-tasks mr-2"></i>待办清单
                    </h3>
                    <div class="relative">
                        <span id="taskCount" class="bg-primary text-white text-xs rounded-full px-2 py-1">0</span>
                    </div>
                </div>
                
                <div class="mb-4">
                    <div class="flex space-x-2">
                        <input type="text" id="newTaskInput" placeholder="添加新任务..." 
                            class="flex-1 px-4 py-2 border border-light rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 bg-transparent text-black">
                        <button id="addTaskBtn" class="bg-primary text-black px-4 py-2 rounded-lg hover:bg-primary-light transition-colors">
                            <i class="fa fa-plus"></i>
                        </button>
                    </div>
                </div>
                
                <div id="taskList" class="space-y-2 max-h-[500px] overflow-y-auto pr-2">
                    <!-- 待办事项将通过JavaScript动态生成 -->
                    <div class="text-center py-8 text-gray-400">
                        <i class="fa fa-check-circle text-4xl mb-3"></i>
                        <p>暂无待办事项</p>
                    </div>
                </div>
            </div>

            <!-- 日程表单区域 -->
            <div class="lg:col-span-7 card rounded-xl hover:shadow-lg">
                <h3 class="text-xl font-bold text-primary flex items-center mb-6">
                    <i class="fa fa-plus-circle mr-2"></i>添加日程
                </h3>
                
                <form id="eventForm" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="form-group">
                        <label for="eventTitle" class="block text-sm font-medium text-gray-700 mb-1">事件名称</label>
                        <input type="text" id="eventTitle" class="w-full px-4 py-2 border border-light rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 bg-transparent text-black" placeholder="输入事件名称">
                    </div>
                    
                    <div class="form-group">
                        <label for="eventDate" class="block text-sm font-medium text-gray-700 mb-1">日期</label>
                        <input type="date" id="eventDate" class="w-full px-4 py-2 border border-light rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 bg-transparent text-black">
                    </div>
                    
                    <div class="form-group">
                        <label for="eventTime" class="block text-sm font-medium text-gray-700 mb-1">时间</label>
                        <input type="time" id="eventTime" class="w-full px-4 py-2 border border-light rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 bg-transparent text-black">
                    </div>
                    
                    <div class="form-group md:col-span-3">
                        <label for="eventDescription" class="block text-sm font-medium text-gray-700 mb-1">描述</label>
                        <textarea id="eventDescription" rows="3" class="w-full px-4 py-2 border border-light rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 bg-transparent text-black" placeholder="输入事件描述（可选）"></textarea>
                    </div>
                    
                    <div class="form-group md:col-span-3 flex justify-end">
                        <button type="button" id="submitEventBtn" class="bg-primary text-white px-6 py-3 rounded-lg hover:bg-primary-light transition-colors flex items-center">
                            <i class="fa fa-calendar-plus-o mr-2"></i>添加日程
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 事件模态框 -->
        <div id="eventModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
            <div id="eventModalContent" class="bg-white rounded-lg p-6 max-w-lg w-full mx-4">
                <!-- 模态框内容将由 JavaScript 动态填充 -->
            </div>
        </div>

        <!-- 添加事件按钮 -->
        <button onclick="showAddEventModal()" class="fixed bottom-8 right-8 bg-primary text-white p-4 rounded-full shadow-lg hover:bg-primary-dark transition-colors">
            <i class="fa fa-plus"></i>
        </button>

        <!-- 添加事件模态框 -->
        <div id="addEventModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 max-w-lg w-full mx-4">
                <h3 class="text-xl font-bold mb-4">添加新事件</h3>
                <form id="addEventForm" onsubmit="addEvent(); return false;">
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="eventTitle">
                            事件名称
                        </label>
                        <input type="text" id="eventTitle" name="title" required
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="eventDate">
                            日期
                        </label>
                        <input type="date" id="eventDate" name="date" required
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="eventTime">
                            时间
                        </label>
                        <input type="time" id="eventTime" name="time" required
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="eventDescription">
                            描述
                        </label>
                        <textarea id="eventDescription" name="description"
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"></textarea>
                    </div>
                    <div class="flex justify-end space-x-2">
                        <button type="button" onclick="closeAddEventModal()"
                            class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">取消</button>
                        <button type="submit"
                            class="px-4 py-2 bg-primary text-white rounded hover:bg-primary-dark">保存</button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <footer class="py-8 px-4 md:px-8 text-center fade-in">
        <div class="flex flex-col items-center">
            <div class="mb-4 text-lg font-medium">作者: 赵一芬 李思妍</div>
            <p class="text-sm opacity-70">© 2025 SignLink手语通. 保留所有权利.</p>
        </div>
    </footer>
    <script>
        // 获取CSRF Token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // 显示添加事件模态框
        function showAddEventModal() {
            const modal = document.getElementById('addEventModal');
            modal.classList.remove('hidden');
        }

        // 关闭添加事件模态框
        function closeAddEventModal() {
            const modal = document.getElementById('addEventModal');
            modal.classList.add('hidden');
        }

        // 显示通知
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed bottom-4 right-4 bg-primary text-white px-4 py-2 rounded-lg shadow-lg z-50 fade-in';
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateY(10px)';
                notification.style.transition = 'opacity 0.3s, transform 0.3s';
                
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }

        // 格式化日期为 YYYY-MM-DD
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // 当前日期
        const today = new Date();
        let currentDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());

        // 获取月数据
        function fetchMonthData(date) {
            const year = date.getFullYear();
            const month = date.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            fetch(`/Schedule/events/?start_date=${formatDate(firstDay)}&end_date=${formatDate(lastDay)}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                credentials: 'include'
            })
            .then(response => {
                if (response.status === 401) {
                    throw new Error('请先登录');
                }
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // 检查数据格式
                if (!data || typeof data !== 'object') {
                    throw new Error('Invalid data format received from server');
                }

                // 确保 data 是数组
                const eventsArray = Array.isArray(data) ? data : [];
                
                // 将事件数据按日期分组
                const eventsByDate = {};
                eventsArray.forEach(event => {
                    if (event && event.date) {
                        const date = event.date;
                        if (!eventsByDate[date]) {
                            eventsByDate[date] = [];
                        }
                        eventsByDate[date].push(event);
                    }
                });
                
                // 渲染日历
                renderCalendar(eventsByDate);
            })
            .catch(error => {
                console.error('Error fetching month data:', error);
                const calendar = document.getElementById('calendar');
                if (calendar) {
                    if (error.message === '请先登录') {
                        calendar.innerHTML = `
                            <div class="col-span-7 text-center py-10 text-red-500">
                                <i class="fa fa-exclamation-triangle text-2xl mb-2"></i>
                                <p>请先登录</p>
                                <p class="text-sm mt-2">您需要登录才能查看日程</p>
                                <a href="{% url 'login' %}" class="inline-block mt-4 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-light transition-colors">
                                    去登录
                                </a>
                            </div>
                        `;
                    } else {
                        calendar.innerHTML = `
                            <div class="col-span-7 text-center py-10 text-red-500">
                                <i class="fa fa-exclamation-triangle text-2xl mb-2"></i>
                                <p>加载日历数据失败</p>
                                <p class="text-sm mt-2">${error.message}</p>
                                <p class="text-sm mt-2">请检查后端服务是否正常运行</p>
                            </div>
                        `;
                    }
                }
            });
        }

        // 渲染日历
        function renderCalendar(eventsByDate = {}) {
            const calendar = document.getElementById('calendar');
            if (!calendar) {
                console.error('Calendar container not found');
                return;
            }
            
            calendar.innerHTML = '';
            
            // 更新月份显示
            const monthNames = ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'];
            document.getElementById('currentMonthDisplay').textContent = 
                `${currentDate.getFullYear()}年${monthNames[currentDate.getMonth()]}`;
            
            // 添加星期头部
            const weekDays = ['周一', '周二', '周三', '周四', '周五', '周六', '周日'];
            const weekHeader = document.createElement('div');
            weekHeader.className = 'grid grid-cols-7 gap-2 mb-2';
            
            weekDays.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'day-header text-center py-2';
                if (day === '周六' || day === '周日') {
                    dayHeader.classList.add('text-amber-600');
                }
                dayHeader.textContent = day;
                weekHeader.appendChild(dayHeader);
            });
            calendar.appendChild(weekHeader);
            
            // 计算当月第一天是星期几 (0-6, 0是星期日)
            const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
            const startingDay = firstDay.getDay() || 7; // 调整为星期一为第一天
            const totalDays = lastDay.getDate();
            
            // 创建日历网格
            const calendarGrid = document.createElement('div');
            calendarGrid.className = 'grid grid-cols-7 gap-2';
            
            // 添加上个月的占位日期
            for (let i = 1; i < startingDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day text-gray-300';
                calendarGrid.appendChild(emptyDay);
            }
            
            // 添加当月的日期
            for (let day = 1; day <= totalDays; day++) {
                const date = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
                const dateStr = formatDate(date);
                
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day relative';
                
                // 检查是否是今天
                const isToday = (
                    day === today.getDate() &&
                    currentDate.getMonth() === today.getMonth() &&
                    currentDate.getFullYear() === today.getFullYear()
                );
                
                if (isToday) {
                    dayCell.classList.add('bg-primary/10', 'border-primary');
                }
                
                // 添加日期
                const dateHeader = document.createElement('div');
                dateHeader.className = 'day-number mb-1';
                dateHeader.textContent = day;
                dayCell.appendChild(dateHeader);
                
                // 添加事件
                if (eventsByDate[dateStr]) {
                    const eventsContainer = document.createElement('div');
                    eventsContainer.className = 'event-list space-y-1';
                    
                    eventsByDate[dateStr].forEach(event => {
                        const eventElement = document.createElement('div');
                        eventElement.className = 'event-item p-1 text-sm rounded cursor-pointer hover:bg-gray-100 truncate';
                        eventElement.textContent = event.title;
                        eventElement.title = event.title; // 添加悬停提示
                        eventElement.onclick = () => showEventDetails(event);
                        eventsContainer.appendChild(eventElement);
                    });
                    
                    dayCell.appendChild(eventsContainer);
                }
                
                calendarGrid.appendChild(dayCell);
            }
            
            calendar.appendChild(calendarGrid);
        }

        // 上个月
        function prevMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            fetchMonthData(currentDate);
        }

        // 下个月
        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            fetchMonthData(currentDate);
        }

        // 回到今天
        function goToToday() {
            currentDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            fetchMonthData(currentDate);
        }

        // 显示事件详情
        function showEventDetails(event) {
            const modal = document.getElementById('eventModal');
            const modalContent = document.getElementById('eventModalContent');
            
            if (!modal || !modalContent) {
                console.error('Modal elements not found');
                return;
            }
            
            modalContent.innerHTML = `
                <h3 class="text-xl font-bold mb-4">${event.title}</h3>
                <p class="mb-2">时间：${event.date} ${event.time}</p>
                <p class="mb-4">${event.description || '无描述'}</p>
                <div class="flex justify-end space-x-2">
                    <button onclick="editEvent(${event.id})" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">编辑</button>
                    <button onclick="deleteEvent(${event.id})" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">删除</button>
                    <button onclick="closeEventModal()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">关闭</button>
                </div>
            `;
            
            modal.classList.remove('hidden');
        }

        // 关闭事件详情模态框
        function closeEventModal() {
            const modal = document.getElementById('eventModal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        // 添加新事件
        function addEvent() {
            const titleInput = document.getElementById('eventTitle');
            const dateInput = document.getElementById('eventDate');
            const timeInput = document.getElementById('eventTime');
            const descriptionInput = document.getElementById('eventDescription');
            
            const title = titleInput.value.trim();
            const date = dateInput.value;
            const time = timeInput.value;
            const description = descriptionInput.value.trim();
            
            if (!title || !date || !time) {
                alert('请填写事件名称、日期和时间');
                return;
            }
            
            fetch('/Schedule/events/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    title: title,
                    date: date,
                    time: time,
                    description: description
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('添加事件失败: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                // 刷新事件列表
                fetchMonthData(currentDate);
                
                // 清空表单
                titleInput.value = '';
                dateInput.value = '';
                timeInput.value = '';
                descriptionInput.value = '';
                
                // 关闭模态框
                closeAddEventModal();
                
                // 显示成功提示
                showNotification('日程添加成功');
            })
            .catch(error => {
                console.error('添加事件失败:', error);
                alert('添加事件失败: ' + error.message);
            });
        }

        // 删除事件
        function deleteEvent(eventId) {
            if (confirm('确定要删除这个事件吗？')) {
                fetch(`/Schedule/events/${eventId}/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('删除事件失败');
                    }
                    closeEventModal();
                    fetchMonthData(currentDate);
                    showNotification('事件已删除');
                })
                .catch(error => {
                    console.error('Error deleting event:', error);
                    alert('删除事件失败');
                });
            }
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            fetchMonthData(currentDate);
            fetchAndRenderTasks();
            
            // 绑定事件监听
            document.getElementById('addTaskBtn').addEventListener('click', function() {
                const input = document.getElementById('newTaskInput');
                const text = input.value.trim();
                
                if (!text) {
                    alert('请输入任务内容');
                    return;
                }
                
                // 如果没有选择日期，默认使用今天
                const eventDate = document.getElementById('eventDate').value;
                const date = eventDate || formatDate(today);
                
                // 先创建事件，然后添加任务
                fetch('/Schedule/events/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        title: '待办事项',
                        date: date,
                        time: '00:00',
                        description: '自动创建的待办事项'
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('创建事件失败: ' + response.status);
                    }
                    return response.json();
                })
                .then(eventData => {
                    // 创建任务
                    return fetch('/Schedule/tasks/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        credentials: 'include',
                        body: JSON.stringify({
                            text: text,
                            event: eventData.id
                        })
                    });
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('添加任务失败: ' + response.status);
                    }
                    return response.json();
                })
                .then(() => {
                    // 清空输入框
                    input.value = '';
                    // 刷新任务列表
                    fetchAndRenderTasks();
                    // 刷新日历
                    fetchMonthData(currentDate);
                    showNotification('任务添加成功');
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('操作失败: ' + error.message);
                });
            });
            
            document.getElementById('newTaskInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('addTaskBtn').click();
                }
            });
            
            document.getElementById('submitEventBtn').addEventListener('click', addEvent);
        });

        // 从API获取并渲染任务
        function fetchAndRenderTasks(date) {
            const targetDate = date || formatDate(today);
            fetch(`/Schedule/tasks/?date=${targetDate}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                credentials: 'include'
            })
            .then(response => {
                if (response.status === 401) {
                    throw new Error('请先登录');
                }
                if (!response.ok) {
                    throw new Error('获取任务数据失败: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                window.tasks = data;  // 保存到全局变量
                renderTaskList();
            })
            .catch(error => {
                console.error('Error fetching tasks:', error);
                const taskList = document.getElementById('taskList');
                if (error.message === '请先登录') {
                    taskList.innerHTML = `
                        <div class="text-center py-8 text-red-500">
                            <i class="fa fa-exclamation-triangle text-4xl mb-3"></i>
                            <p>请先登录</p>
                            <p class="text-sm mt-2">您需要登录才能查看待办事项</p>
                            <a href="{% url 'login' %}" class="inline-block mt-4 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-light transition-colors">
                                去登录
                            </a>
                        </div>
                    `;
                } else {
                    taskList.innerHTML = `
                        <div class="text-center py-8 text-red-500">
                            <i class="fa fa-exclamation-triangle text-4xl mb-3"></i>
                            <p>加载任务数据失败</p>
                            <p class="text-sm mt-2">${error.message}</p>
                        </div>
                    `;
                }
            });
        }

        // 渲染任务列表
        function renderTaskList() {
            const taskList = document.getElementById('taskList');
            const taskCount = document.getElementById('taskCount');
            
            // 更新任务计数
            const incompleteTasks = window.tasks.filter(task => !task.completed);
            taskCount.textContent = incompleteTasks.length;
            
            // 清空任务列表
            taskList.innerHTML = '';
            
            // 如果没有任务，显示空状态
            if (window.tasks.length === 0) {
                taskList.innerHTML = `
                    <div class="text-center py-8 text-gray-400">
                        <i class="fa fa-check-circle text-4xl mb-3"></i>
                        <p>暂无待办事项</p>
                    </div>
                `;
                return;
            }
            
            // 渲染每个任务
            window.tasks.forEach(task => {
                const taskElement = document.createElement('div');
                taskElement.className = `flex items-center p-3 rounded-lg border border-light ${task.completed ? 'bg-gray-50' : 'bg-white'} transition-all`;
                
                taskElement.innerHTML = `
                    <div class="flex items-center">
                        <input type="checkbox" id="task-${task.id}" class="mr-3 h-5 w-5 text-primary rounded border-gray-300 focus:ring-primary" ${task.completed ? 'checked' : ''}>
                        <label for="task-${task.id}" class="flex-1 ${task.completed ? 'text-gray-500 line-through' : ''}">${task.text}</label>
                    </div>
                    <button class="delete-task-btn text-gray-400 hover:text-red-500 transition-colors ml-2" data-id="${task.id}">
                        <i class="fa fa-trash"></i>
                    </button>
                `;
                
                // 添加事件监听
                taskElement.querySelector(`#task-${task.id}`).addEventListener('change', function() {
                    toggleTask(task.id);
                });
                
                taskElement.querySelector('.delete-task-btn').addEventListener('click', function() {
                    deleteTask(task.id);
                });
                
                taskList.appendChild(taskElement);
            });
        }

        // 切换任务完成状态
        function toggleTask(id) {
            fetch(`/Schedule/tasks/${id}/toggle/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                credentials: 'include'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('更新任务状态失败: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                // 更新本地任务状态
                const taskIndex = window.tasks.findIndex(task => task.id === id);
                if (taskIndex !== -1) {
                    window.tasks[taskIndex].completed = data.completed;
                    renderTaskList();
                }
            })
            .catch(error => {
                console.error('Error toggling task:', error);
                alert('更新任务状态失败: ' + error.message);
            });
        }

        // 删除任务
        function deleteTask(id) {
            if (confirm('确定要删除这个任务吗？')) {
                fetch(`/Schedule/tasks/${id}/delete/`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    credentials: 'include'
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('删除任务失败: ' + response.status);
                    }
                    // 刷新任务列表
                    fetchAndRenderTasks();
                    // 刷新事件列表
                    fetchMonthData(currentDate);
                    showNotification('任务已删除');
                })
                .catch(error => {
                    console.error('Error deleting task:', error);
                    alert('删除任务失败: ' + error.message);
                });
            }
        }
    </script>
</body>
</html>
    