{% load static %}
<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>æ‰‹è¯­ç¤¾åŒº - åŠ¨æ€</title>
    <link rel="stylesheet" href="{% static 'css/Community.css' %}">
    <link rel="stylesheet" href="{% static 'css/login_button.css' %}">

    <!-- æœ€æ–°å…è´¹ç‰ˆ Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src=https://cdn.tailwindcss.com></script>
    <script>
        tailwind.config = {
            darkMode: `class`
        }
    </script>

</head>

<body>
    <header class="py-6 px-4 md:px-8 flex justify-between items-center">
        <div class="absolute left-1/2 transform -translate-x-1/2">
            <a class="text-3xl md:text-4xl font-bold fade-in">SignLinkæ‰‹è¯­é€š</a>
            <p class="text-lg md:text-xl opacity-80 fade-in mt-2">è¿æ¥æ‰‹è¯­ä¸–ç•Œï¼Œæ²Ÿé€šæ— éšœç¢</p>
        </div>

        <div class="flex items-center space-x-4 ml-auto">
            {% if user.is_authenticated %}
            <div class="user-menu-box-container">
                <a href="{% url 'my_page' %}" class="user-menu-box-button">
                    {% if user.avatar %}
                    <img src="{{ user.avatar.url }}" alt="å¤´åƒ" class="user-menu-box-avatar">
                    {% else %}
                    <img src="{% static 'images/default_avatar.png' %}" alt="é»˜è®¤å¤´åƒ" class="user-menu-box-avatar">
                    {% endif %}
                    {{ user.username }}
                </a>
                <div class="user-menu-box-dropdown">
                    <a href="{% url 'my_page' %}">è¿›å…¥ä¸ªäººä¸»é¡µ</a>
                    <a href="{% url 'logout' %}">é€€å‡ºç™»å½•</a>
                </div>
            </div>
            {% else %}
            <a href="{% url 'login' %}" class="user-menu-box-login">
                <i class="fas fa-user"></i> ç™»å½•
            </a>
            {% endif %}
        </div>
    </header>
    <nav class="sticky top-0 bg-opacity-90 backdrop-blur-sm py-4 px-4 md:px-8 z-50 fade-in"
        style="background-color:var(--card-bg)">
        <div class="container mx-auto flex justify-center space-x-8">
            <a class="nav-link text-lg font-medium" href="{% url 'home' %}" style="color:var(--text-color)">é¦–é¡µ</a>
            <a class="nav-link text-lg font-medium" href="{% url 'sl_classroom' %}"
                style="color:var(--text-color)">æ‰‹è¯­æ•™å®¤</a>
            <a class="nav-link text-lg font-medium" href="{% url 'life_serving' %}"
                style="color:var(--text-color)">ç”Ÿæ´»æœåŠ¡</a>
            <a class="nav-link text-lg font-medium" href="{% url 'community' %}"
                style="color:var(--text-color)">æ‰‹è¯­ç¤¾åŒº</a>
            <a class="nav-link text-lg font-medium" href="{% url 'schedule' %}" style="color:var(--text-color)">æ—¥ç¨‹ç®¡ç†</a>
            <a class="nav-link text-lg font-medium" href="{% url 'my_page' %}" style="color:var(--text-color)">æˆ‘çš„</a>
        </div>
    </nav>

    <nav class="navbar">
        <div class="logo">
            <span class="title-highlight"><i class="fa-regular fa-hand-spock"></i>æ‰‹è¯­ç¤¾åŒº
        </div></span>
        <div class="search-box">
            <input type="text" class="search-input" placeholder="æœç´¢åŠ¨æ€æˆ–ç”¨æˆ·...">
            <button class="search-button">ğŸ”</button>

        </div>
    </nav>

    <h1 class="section-title"></h1>
    <div class="container">
        <div class="post-list">
            <!-- å‘å¸ƒæ¡† -->
            <form method="post" action="/Community/create_post/" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="post-editor">
                    <textarea class="editor-input" placeholder="åˆ†äº«ä½ çš„æƒ³æ³•æˆ–æ‰‹è¯­è§†é¢‘..." name="content"></textarea>
                    <div class="post-actions">
                        <div class="action-buttons">
                            <button type="button" onclick="document.getElementById('image').click()" title="æ·»åŠ å›¾ç‰‡">
                                ğŸ“¸ å›¾ç‰‡
                            </button>
                            <input type="file" id="image" name="image" accept="image/*" hidden>
                            <button type="button" onclick="document.getElementById('video').click()" title="æ·»åŠ è§†é¢‘">
                                ğŸ¥ è§†é¢‘
                            </button>
                            <input type="file" id="video" name="video" accept="video/*" hidden>
                            <button type="button" onclick="addTag()" title="æ·»åŠ æ ‡ç­¾">
                                ğŸ·ï¸ æ ‡ç­¾
                            </button>
                            <input type="text" id="tags" name="tags" placeholder="#æ ‡ç­¾" hidden>

                        </div>
                        <button type="submit" class="post-button">å‘å¸ƒ</button>
                    </div>
                </div>
            </form>

            <!-- åŠ¨æ€ç¤ºä¾‹ -->

            <!-- <div class="post-card">
                <div class="post-header">
                    <img src="{% static 'images/proflie1.png'%}" class="user-avatar" alt="ç”¨æˆ·å¤´åƒ">
                    <div>
                        <h3>æ‰‹è¯­è¾¾äººå°ç‹</h3>
                        <p>2å°æ—¶å‰ Â· ğŸ“åŒ—äº¬</p>
                    </div>
                </div>
                <div class="post-content">
                    <p>ä»Šå¤©çš„æ‰‹è¯­æ•™å­¦è§†é¢‘æ¥å•¦ï¼æ•™å¤§å®¶"è°¢è°¢"å’Œ"ä¸å®¢æ°”"çš„è¡¨è¾¾æ–¹å¼ ğŸ‘‡</p>
                </div>
                <div class="post-media">
                    <video controls style="max-width: 50%; height: auto;">
                        <source src="{% static 'images/community_video.mp4'%}" type="video/mp4">
                    </video>
                </div>
                <div class="post-tags">
                    <span class="tag">#æ‰‹è¯­æ•™å­¦</span>
                    <span class="tag">#æ¯æ—¥ä¸€è¯¾</span>
                </div>
                
                <div class="post-actions">
                    <div class="action-button">â¤ï¸ 1.2ä¸‡</div>
                    <div class="action-button">ğŸ’¬ 845</div>
                    <div class="action-button">ğŸ”„ 326</div>
                </div>
            </div>

            
            <div class="post-card">
                <div class="post-header">
                    <img src="{% static 'images/profile2.png'%}" class="user-avatar" alt="ç”¨æˆ·å¤´åƒ">
                    <div>
                        <h3>åŠªåŠ›ç”Ÿé•¿çš„å°è‹—</h3>
                        <p>1å¤©å‰ Â· ğŸ“ä¸Šæµ·</p>
                    </div>
                </div>
                <div class="post-content">
                    <p>å¥½å¼€å¿ƒï¼ä»Šå¤©æ”¶åˆ°ç¤¾åŒºçš„é€šçŸ¥ï¼Œå‘å¸ƒäº†å¥½å¤šé€‚åˆå’±ä»¬è‹å“‘äººçš„å²—ä½ï¼Œæ„Ÿå—åˆ°äº†æ»¡æ»¡çˆ±æ„~</p>
                </div>
                <div class="post-tags">
                    <span class="tag">#å·¥ä½œå²—ä½</span>
                    <span class="tag">#å¿ƒæƒ…åˆ†äº«</span>
                </div>
                
                <div class="post-actions">
                    <div class="action-button">â¤ï¸ 3208</div>
                    <div class="action-button">ğŸ’¬ 45</div>
                    <div class="action-button">ğŸ”„ 285</div>
                </div>
            </div>
            <div class="post-card">
                <div class="post-header">
                    <img src="{% static 'images/profile3.png'%}" class="user-avatar" alt="ç”¨æˆ·å¤´åƒ">
                    <div>
                        <h3>è¶…è¶…å®¶çš„èŠ±</h3>
                        <p>1å¤©å‰ Â· ğŸ“äº‘å—</p>
                    </div>
                </div>
                <div class="post-content">
                    <p>ç»™çŒ«çŒ«è‰æŒ‰æ—¶æµ‡æ°´çš„ç¬¬9å¤©ï¼Œå·²ç»é•¿å‡º3cmé«˜äº†ï¼æ„Ÿè°¢å¥½å¤©æ°”</p>
                </div>
                <div class="post-tags">
                    <span class="tag">#ç§æ¤</span>
                    <span class="tag">#å¿ƒæƒ…åˆ†äº«</span>
                </div>
                
                <div class="post-actions">
                    <div class="action-button">â¤ï¸ 227</div>
                    <div class="action-button">ğŸ’¬ 85</div>
                    <div class="action-button">ğŸ”„ 32</div>
                </div>
            </div> -->


            {% for post in posts %}
            <div class="post-card">
                <!-- ç”¨æˆ·ä¿¡æ¯åŒº -->
                <div class="post-header relative">
                    {% if post.user.avatar %}
                    <img class="w-10 h-10 rounded-full object-cover" src="{{ post.user.avatar.url }}"
                        class="user-avatar" alt="ç”¨æˆ·å¤´åƒ">
                    {% else %}
                    <img src="{% static 'images/default_avatar.png' %}" class="user-avatar" alt="é»˜è®¤å¤´åƒ">
                    {% endif %}
                    <div>
                        <h3>{{ post.user.username }}</h3>
                        <p>{{ post.created_at|timesince }}å‰</p>
                    </div>

                    <!-- å…³æ³¨æŒ‰é’® -->
                    {% if request.user != post.user %}
                    <button
                        class="absolute top-2 right-2 bg-blue-500 text-white text-sm px-3 py-1 rounded hover:bg-blue-600 follow-btn action-button"
                        data-user-id="{{ post.user.id }}">
                        <i class="fas {% if post.is_followed %}fa-user-check{% else %}fa-user-plus{% endif %}"></i>
                        <span class="follow-text">
                            {% if post.is_followed %}å·²å…³æ³¨{% else %}å…³æ³¨{% endif %}
                        </span>
                    </button>
                    {% endif %}




                </div>

                <!-- å¸–å­å†…å®¹ -->
                <div class="post-content">
                    <p>{{ post.content }}</p>
                </div>

                <!-- åª’ä½“æ–‡ä»¶ï¼ˆè§†é¢‘/å›¾ç‰‡ï¼‰ -->
                <div class="post-media">
                    {% if post.image %}
                    <img src="{{ post.image.url }}" style="max-width: 100%;" alt="å¸–å­å›¾ç‰‡">
                    {% endif %}
                    {% if post.video %}
                    <video controls style="max-width: 50%; height: auto;">
                        <source src="{{ post.video.url }}" type="video/mp4">
                    </video>
                    {% endif %}
                </div>

                <!-- äº’åŠ¨æŒ‰é’® -->
                <div class="post-actions">
                    <!-- â¤ï¸ ç‚¹èµ -->
                    <button class="action-button like-btn" data-post-id="{{ post.id }}">
                        <i class="fa-regular fa-heart"></i> {{ post.like_count }}
                    </button>

                    <!-- ğŸ’¬ è¯„è®º -->
                    <div class="flex justify-between items-center mb-2">
                        <div class="text-sm text-gray-600">
                            <i class="fa-regular fa-comment-dots"></i> {{ post.comment_count }}
                        </div>
                    </div>

                    <!-- â­ æ”¶è— -->
                    <button class="action-button favorite-btn" data-post-id="{{ post.id }}">
                        <i class="fa-regular fa-bookmark"></i> {{ post.favorite_count }}
                    </button>

                </div>

                <!-- è¯„è®ºåŒº -->
                <div class="post-comments">
                    <div class="comment-list" id="comment-list-{{ post.id }}">
                        {% for comment in post.comment_set.all %}
                        <div class="comment-item">
                            <strong>{{ comment.user.username }}</strong>: {{ comment.content }}
                        </div>
                        {% endfor %}
                    </div>

                    <form class="comment-form flex items-center mt-2 gap-2" data-post-id="{{ post.id }}">
                        <input type="text" name="content"
                            class="flex-1 px-3 py-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-400"
                            placeholder="å†™ä¸‹ä½ çš„è¯„è®º..." required>
                        <button type="submit"
                            class="px-4 py-2 bg-blue-500 text-white rounded-xl hover:bg-blue-600 transition">å‘é€</button>
                    </form>
                </div>
            </div>
            {% endfor %}


        </div>




        <!-- ä¾§è¾¹æ  -->
        <div class="sidebar">
            <div class="trending-topics">
                <h3>çƒ­é—¨è¯é¢˜</h3>
                <div class="topic-item">#æ— éšœç¢è®¾æ–½æŒ‡å—</div>
                <div class="topic-item">#æ‰‹è¯­æ•…äº‹åˆ†äº«</div>
                <div class="topic-item">#å°±ä¸šä¿¡æ¯é€Ÿé€’</div>
                <div class="topic-item">#æ‰‹è¯­è¯—æ­Œåˆ›ä½œ</div>
            </div>
        </div>
    </div>

    <hr class="dashed">

    <footer class="py-8 px-4 md:px-8 text-center fade-in" style="animation-delay:1.2s">
        <div class="mx-auto max-w-4xl"> <!-- å…¸å‹å†…å®¹å®½åº¦ -->
            <div class="flex flex-col items-center justify-center">
                <div class="mb-4 text-lg font-medium">ä½œè€…: èµµä¸€èŠ¬ å¾åª›é“ƒ ææ€å¦</div>
                <p class="text-sm opacity-70">Â© 2025 SignLinkæ‰‹è¯­é€š. ä¿ç•™æ‰€æœ‰æƒåˆ©.</p>
            </div>
        </div>
    </footer>

    <script>
        const isLoggedIn = {{ user.is_authenticated|yesno:"true,false"|safe }};

        // è·å– CSRF Token è¾…åŠ©å‡½æ•°
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    cookie = cookie.trim();
                    if (cookie.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // ç‚¹èµæŒ‰é’®
        document.querySelectorAll('.like-btn').forEach(button => {
            button.addEventListener('click', () => {
                if (!isLoggedIn) {
                    alert("è¯·å…ˆç™»å½•å†ç‚¹èµï¼");
                    window.location.href = "/users/login/";
                    return;
                }

                const postId = button.getAttribute('data-post-id');
                fetch(`/Community/like_post/${postId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/json'
                    },
                    credentials: 'same-origin',
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            button.innerHTML = `â¤ï¸ ${data.likes}`;
                            button.disabled = true;
                        } else {
                            alert(data.message || 'æ‚¨å·²ç»ç‚¹è¿‡èµäº†');
                        }
                    });
            });
        });

        // è¯„è®ºæäº¤
        document.querySelectorAll('.comment-form').forEach(form => {
            form.addEventListener('submit', function (e) {
                e.preventDefault();

                if (!isLoggedIn) {
                    alert("è¯·å…ˆç™»å½•åå†å‘è¡¨è¯„è®ºï¼");
                    window.location.href = "/users/login/";
                    return;
                }

                const postId = form.getAttribute('data-post-id');
                const input = form.querySelector('input[name="content"]');
                const content = input.value.trim();

                if (!content) return;

                fetch(`/Community/comment_post/${postId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: `content=${encodeURIComponent(content)}`,
                    credentials: 'same-origin',
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            const list = document.getElementById(`comment-list-${postId}`);
                            const newComment = document.createElement('div');
                            newComment.className = 'comment-item';
                            newComment.innerHTML = `<strong>${data.username}</strong>: ${data.content}`;
                            list.appendChild(newComment);
                            input.value = '';
                        } else {
                            alert(data.message || 'è¯„è®ºå¤±è´¥');
                        }
                    });
            });
        });

        // æ”¶è—æŒ‰é’®
        document.querySelectorAll('.favorite-btn').forEach(button => {
            button.addEventListener('click', () => {
                if (!isLoggedIn) {
                    alert("è¯·å…ˆç™»å½•åå†æ”¶è—ï¼");
                    window.location.href = "/users/login/";
                    return;
                }

                const postId = button.getAttribute('data-post-id');
                fetch(`/Community/favorite_post/${postId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/json'
                    },
                    credentials: 'same-origin',
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            button.innerHTML = `â­ ${data.favorites}`;
                            button.disabled = true;
                        } else {
                            alert(data.message || 'æ‚¨å·²ç»æ”¶è—è¿‡äº†');
                        }
                    });
            });
        });

        // å…³æ³¨æŒ‰é’®
        document.querySelectorAll('.follow-btn').forEach(button => {
            button.addEventListener('click', () => {
                if (!isLoggedIn) {
                    alert("è¯·å…ˆç™»å½•åå†å…³æ³¨ç”¨æˆ·ï¼");
                    window.location.href = "/users/login/";
                    return;
                }

                const userId = button.getAttribute('data-user-id');
                fetch(`/Community/toggle_follow/${userId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/json'
                    },
                    credentials: 'same-origin',
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            const icon = button.querySelector('i');
                            const label = button.querySelector('.follow-text');

                            if (data.following) {
                                icon.classList.remove('fa-user-plus');
                                icon.classList.add('fa-user-check');
                                label.textContent = 'å·²å…³æ³¨';
                            } else {
                                icon.classList.remove('fa-user-check');
                                icon.classList.add('fa-user-plus');
                                label.textContent = 'å…³æ³¨';
                            }
                        } else {
                            alert(data.message);
                        }
                    });
            });
        });



    </script>

</body>

</html>